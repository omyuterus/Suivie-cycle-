<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon suivi du cycle</title>

  <style>
    :root{
      --bg:#fbf7f4;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --accent:#a74d5e;
      --green:#93b087;
      --dark:#244135;
      --border:#eadfd7;
      --shadow: 0 10px 30px rgba(31,41,55,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      background: radial-gradient(1200px 600px at 10% 10%, rgba(167,77,94,.10), transparent 60%),
                  radial-gradient(1000px 500px at 90% 20%, rgba(147,176,135,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:20px 16px 8px;
      max-width:1120px;
      margin:0 auto;
    }
    .title{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .badge{
      font-size:12px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:rgba(255,255,255,.7);
      color:var(--muted);
    }
    h1{margin:0;font-size:22px;letter-spacing:-.3px}
    p.lead{margin:10px 0 0;color:var(--muted);line-height:1.45;max-width:96ch}

    main{
      max-width:1120px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
    }
    @media (max-width: 1000px){ main{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px;font-size:16px;color:var(--dark)}
    .note{
      background: rgba(147,176,135,.10);
      border:1px dashed rgba(147,176,135,.55);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      line-height:1.35;
      margin:10px 0 14px;
    }
    .note2{
      background: rgba(167,77,94,.08);
      border:1px dashed rgba(167,77,94,.35);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      line-height:1.35;
      margin:10px 0 14px;
    }
    .muted{color:var(--muted)}
    form{display:grid;gap:12px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], input[type="month"], input[type="date"], textarea, select, input[type="number"]{
      width:100%;
      padding:12px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      outline:none;
      font-size:14px;
      background:#fff;
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns: 1fr 1fr;gap:12px}
    @media (max-width:650px){ .row{grid-template-columns:1fr} }

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border:1px solid var(--border);
      border-radius:999px;background: rgba(255,255,255,.85);
      cursor:pointer;user-select:none;font-size:13px;color:var(--text);
    }
    .chip input{ accent-color: var(--accent); }

    .scale{
      display:grid;
      grid-template-columns: repeat(11, 1fr);
      gap:6px;align-items:center;
    }
    .scale input{
      width:100%;height:42px;border-radius:14px;border:1px solid var(--border);
      appearance:none;background:#fff;cursor:pointer;
    }
    .scale input:checked{
      border:2px solid var(--accent);
      box-shadow: 0 0 0 4px rgba(167,77,94,.12);
      background: rgba(167,77,94,.08);
    }

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px}
    button{
      border:none;padding:12px 14px;border-radius:14px;cursor:pointer;
      font-weight:800;font-size:14px;
    }
    .btn-primary{background:var(--accent);color:#fff}
    .btn-secondary{background:rgba(147,176,135,.18);color:var(--dark)}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
    .btn-danger{background:rgba(167,77,94,.12);border:1px solid rgba(167,77,94,.25);color:var(--dark)}

    .small{font-size:12px;color:var(--muted);line-height:1.35;margin:8px 0 0}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tab{
      padding:10px 12px;border-radius:999px;border:1px solid var(--border);
      background:#fff;cursor:pointer;font-size:13px;color:var(--muted);
    }
    .tab.active{
      color:var(--dark);
      border-color: rgba(167,77,94,.35);
      box-shadow: 0 0 0 4px rgba(167,77,94,.10);
    }

    .list{display:grid;gap:10px}
    .entry{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background: rgba(251,247,244,.55);
    }
    .meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;color:var(--muted);font-size:12px}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .strong{font-weight:900;color:var(--dark)}
    .divider{height:1px;background:rgba(234,223,215,.8);margin:12px 0}
    canvas{ width:100% !important; height:260px !important; }
  </style>
</head>

<body>
<header>
  <div class="title">
    <h1>Mon suivi du cycle ğŸŒ™</h1>
    <span class="badge">Confidentiel Â· enregistrÃ© sur TON appareil</span>
    <span class="badge">Tu peux modifier Ã  tout moment</span>
  </div>
  <p class="lead">Tu notes quand tu veux. Objectif : comprendre ton corps, sans te juger.</p>
</header>

<main>
  <!-- LEFT -->
  <section class="card">
    <h2>ğŸ©· Mon suivi du mois</h2>

    <div class="note">
      âœ… Tu peux noter <b>tous les jours</b> si tu veux.<br>
      âœ… Tu peux modifier ton mois <b>Ã  tout moment</b>.<br>
      âœ… Personne ne voit : câ€™est enregistrÃ© sur <b>ton appareil</b>.
    </div>

    <form id="monthForm">
      <div class="row">
        <div>
          <label for="month">Mois</label>
          <input id="month" type="month" required />
        </div>
        <div>
          <label for="nickname">PrÃ©nom / pseudo (facultatif)</label>
          <input id="nickname" type="text" placeholder="ex : Lina / Lili / ğŸŒ¸" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="startDate">DÃ©but des rÃ¨gles</label>
          <input id="startDate" type="date" />
        </div>
        <div>
          <label for="endDate">Fin des rÃ¨gles</label>
          <input id="endDate" type="date" />
        </div>
      </div>

      <!-- DOULEUR DU MOIS (juste sous fin des rÃ¨gles) -->
      <div class="note2">
        <div class="strong">ğŸ©¸ Pendant tes rÃ¨gles (ce mois-ci)</div>
        <label style="margin-top:10px;">As-tu eu mal pendant tes rÃ¨gles ?</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="monthPainYesNo" value="oui"> Oui</label>
          <label class="chip"><input type="radio" name="monthPainYesNo" value="non"> Non</label>
        </div>

        <div id="monthPainDetails" style="display:none; margin-top:10px;">
          <label>IntensitÃ© (0â€“10)</label>
          <div class="scale" id="monthPainScale"></div>

          <label style="margin-top:10px;">Quâ€™est-ce qui tâ€™a aidÃ©e ? (tu peux cocher plusieurs)</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="monthRelief" value="Bouillotte / chaleur"> ğŸ”¥ Bouillotte / chaleur</label>
            <label class="chip"><input type="checkbox" name="monthRelief" value="Position"> ğŸ›Œ Position</label>
            <label class="chip"><input type="checkbox" name="monthRelief" value="Respiration"> ğŸŒ¬ï¸ Respiration</label>
            <label class="chip"><input type="checkbox" name="monthRelief" value="Camomille"> ğŸŒ¼ Camomille</label>
            <label class="chip"><input type="checkbox" name="monthRelief" value="MÃ©lisse"> ğŸƒ MÃ©lisse</label>
            <label class="chip"><input type="checkbox" name="monthRelief" value="Verveine"> ğŸŒ¿ Verveine</label>
            <label class="chip"><input type="checkbox" name="monthRelief" value="Djeka"> ğŸ«– Djeka</label>
            <label class="chip"><input type="checkbox" name="monthRelief" value="KhamarÃ©"> ğŸ«– KhamarÃ©</label>
            <label class="chip"><input type="checkbox" name="monthRelief" value="MÃ©dicament"> ğŸ’Š MÃ©dicament</label>
            <label class="chip"><input type="checkbox" name="monthRelief" value="Rien"> ğŸ™ƒ Rien</label>
          </div>

          <label style="margin-top:10px;">
            Est-ce que Ã§a a aidÃ© ?
            <span style="color:#6b7280;font-size:12px;">(parfois il faut plusieurs cycles)</span>
          </label>
          <div class="chips">
            <label class="chip"><input type="radio" name="monthReliefWorked" value="Oui"> Oui âœ…</label>
            <label class="chip"><input type="radio" name="monthReliefWorked" value="Un peu"> Un peu ğŸ™‚</label>
            <label class="chip"><input type="radio" name="monthReliefWorked" value="Pas vraiment"> Pas vraiment ğŸ˜•</label>
            <label class="chip"><input type="radio" name="monthReliefWorked" value="Je ne sais pas"> Je ne sais pas</label>
          </div>

          <div class="note2" id="monthPainAdvice" style="margin-top:10px; display:none;"></div>
        </div>
      </div>

      <!-- RAMADAN -->
      <div class="note2">
        <div class="strong">ğŸŒ™ Ramadan (manuel + rÃ©actif)</div>
        <div class="small muted">Tu mets ton total, puis tu ajoutes au fur et Ã  mesure â†’ â€œrestantsâ€ se calcule tout seul.</div>
      </div>

      <div class="row">
        <div>
          <label class="chip" style="justify-content:center; width:100%;">
            <input type="checkbox" id="ramadan" />
            Jâ€™ai des jours Ã  rattraper (Ramadan)
          </label>
        </div>
        <div>
          <label for="ramadanTotal">Total de jours Ã  rattraper</label>
          <input id="ramadanTotal" type="number" min="0" step="1" placeholder="ex : 5" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="ramadanDone">Jours dÃ©jÃ  rattrapÃ©s</label>
          <input id="ramadanDone" type="number" min="0" step="1" placeholder="ex : 1" />
          <div class="actions">
            <button class="btn-secondary" type="button" id="ramadanPlusOneBtn">+1 jour rattrapÃ©</button>
            <button class="btn-secondary" type="button" id="ramadanDoneBtn">Jâ€™ai fini âœ…</button>
            <button class="btn-ghost" type="button" id="ramadanResetBtn">Remettre Ã  zÃ©ro (Ramadan suivant)</button>
          </div>
        </div>
        <div>
          <label>Jours restants</label>
          <input id="ramadanRemaining" type="text" disabled />
          <div class="note" id="ramadanCongrats" style="display:none; margin-top:10px;">
            ğŸ‰ Bravo ! Tu as tout rattrapÃ©.
          </div>
        </div>
      </div>

      <div class="note2" id="monthStatusBox"></div>

      <div class="actions">
        <button class="btn-secondary" type="button" id="saveMonthBtn">Enregistrer / mettre Ã  jour le mois</button>
        <button class="btn-ghost" type="button" id="exportMonthBtn">ğŸ“„ Export rÃ©sumÃ© (texte)</button>
      </div>

      <div class="divider"></div>

      <h2 style="margin-top:0;">â• Ajouter une entrÃ©e (quotidienne si tu veux)</h2>
      <div class="note">Une entrÃ©e = un mini pointage (douleur, ovulation, humeurâ€¦). Tu peux en faire tous les jours.</div>

      <div class="row">
        <div>
          <label for="entryDate">Date</label>
          <input id="entryDate" type="date" required />
        </div>
        <div>
          <label for="entryType">Type</label>
          <select id="entryType" required>
            <option value="" selected disabled>Choisirâ€¦</option>
            <option value="ovulation">Ovulation / signes</option>
            <option value="regles">RÃ¨gles / douleur (jour)</option>
            <option value="spm">SPM / humeur / stress</option>
            <option value="plantes">Plantes / solutions testÃ©es</option>
            <option value="alimentation">Alimentation (simple)</option>
            <option value="note">Note libre</option>
          </select>
        </div>
      </div>

      <!-- OVULATION -->
      <div id="ovulationBlock" style="display:none;">
        <label>Ovulation : signes</label>
        <div class="chips">
          <label class="chip"><input type="checkbox" name="ovuSigns" value="Tiraillement ovaire"> Tiraillement ovaire</label>
          <label class="chip"><input type="checkbox" name="ovuSigns" value="Pertes plus gluantes"> Pertes plus gluantes</label>
          <label class="chip"><input type="checkbox" name="ovuSigns" value="Pertes plus abondantes"> Pertes plus abondantes</label>
          <label class="chip"><input type="checkbox" name="ovuSigns" value="Ã‰nergie diffÃ©rente"> Ã‰nergie diffÃ©rente</label>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>Si tiraillement : cÃ´tÃ© ?</label>
            <select id="ovuSide">
              <option value="" selected>Je ne sais pas / pas ressenti</option>
              <option value="gauche">Gauche</option>
              <option value="droite">Droite</option>
            </select>
          </div>
          <div>
            <label>Pertes : aspect</label>
            <select id="mucusType">
              <option value="" selected>Je ne sais pas</option>
              <option value="crÃ©meux">CrÃ©meux / blanc</option>
              <option value="gluant">Gluant / â€œblanc dâ€™Å“ufâ€</option>
              <option value="aqueux">Aqueux</option>
              <option value="sec">Sec / peu</option>
            </select>
          </div>
        </div>
      </div>

      <!-- REGLES / DOULEUR JOUR -->
      <div id="painBlock" style="display:none;">
        <label>As-tu eu mal aujourdâ€™hui ?</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="painYesNo" value="oui"> Oui</label>
          <label class="chip"><input type="radio" name="painYesNo" value="non"> Non</label>
        </div>

        <div id="painDetails" style="display:none; margin-top:10px;">
          <label>Si oui : oÃ¹ ?</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="painWhere" value="Bas-ventre"> Bas-ventre</label>
            <label class="chip"><input type="checkbox" name="painWhere" value="Dos / reins"> Dos / reins</label>
            <label class="chip"><input type="checkbox" name="painWhere" value="Entre les jambes"> Entre les jambes</label>
            <label class="chip"><input type="checkbox" name="painWhere" value="Autre"> Autre</label>
          </div>

          <div style="margin-top:10px;">
            <label>IntensitÃ© (0â€“10)</label>
            <div class="scale" id="painScale"></div>
          </div>

          <label style="margin-top:10px;">Quâ€™est-ce que tu as testÃ© ?</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" name="relief" value="Bouillotte / chaleur"> ğŸ”¥ Bouillotte / chaleur</label>
            <label class="chip"><input type="checkbox" name="relief" value="Position"> ğŸ›Œ Position</label>
            <label class="chip"><input type="checkbox" name="relief" value="Respiration"> ğŸŒ¬ï¸ Respiration</label>
            <label class="chip"><input type="checkbox" name="relief" value="Camomille"> ğŸŒ¼ Camomille</label>
            <label class="chip"><input type="checkbox" name="relief" value="MÃ©lisse"> ğŸƒ MÃ©lisse</label>
            <label class="chip"><input type="checkbox" name="relief" value="Verveine"> ğŸŒ¿ Verveine</label>
            <label class="chip"><input type="checkbox" name="relief" value="Djeka"> ğŸ«– Djeka</label>
            <label class="chip"><input type="checkbox" name="relief" value="KhamarÃ©"> ğŸ«– KhamarÃ©</label>
            <label class="chip"><input type="checkbox" name="relief" value="MÃ©dicament"> ğŸ’Š MÃ©dicament</label>
            <label class="chip"><input type="checkbox" name="relief" value="Rien"> ğŸ™ƒ Rien</label>
          </div>

          <label style="margin-top:10px;">
            Est-ce que Ã§a tâ€™a aidÃ©e ?
            <span style="color:#6b7280;font-size:12px;">(parfois il faut plusieurs cycles)</span>
          </label>
          <div class="chips">
            <label class="chip"><input type="radio" name="reliefWorked" value="Oui, beaucoup"> Oui, beaucoup âœ…</label>
            <label class="chip"><input type="radio" name="reliefWorked" value="Un peu"> Un peu ğŸ™‚</label>
            <label class="chip"><input type="radio" name="reliefWorked" value="Pas trop"> Pas trop ğŸ˜•</label>
            <label class="chip"><input type="radio" name="reliefWorked" value="Je ne sais pas"> Je ne sais pas</label>
          </div>
        </div>
      </div>

      <!-- SPM -->
      <div id="spmBlock" style="display:none;">
        <label>SPM / humeur (tu peux cocher plusieurs)</label>
        <div class="chips">
          <label class="chip"><input type="checkbox" name="mood" value="Calme"> ğŸ™‚ Calme</label>
          <label class="chip"><input type="checkbox" name="mood" value="StressÃ©e"> ğŸ˜µ StressÃ©e</label>
          <label class="chip"><input type="checkbox" name="mood" value="FatiguÃ©e"> ğŸ˜´ FatiguÃ©e</label>
          <label class="chip"><input type="checkbox" name="mood" value="Irritable"> ğŸ˜¤ Irritable</label>
          <label class="chip"><input type="checkbox" name="mood" value="Sensible"> ğŸ¥º Sensible</label>
          <label class="chip"><input type="checkbox" name="mood" value="Envie de sucre"> ğŸ« Envie de sucre</label>
          <label class="chip"><input type="checkbox" name="mood" value="Ballonnements"> ğŸˆ Ballonnements</label>
          <label class="chip"><input type="checkbox" name="mood" value="Maux de tÃªte"> ğŸ¤• Maux de tÃªte</label>
        </div>
      </div>

      <!-- PLANTES / SOLUTIONS -->
      <div id="plantsBlock" style="display:none;">
        <label>Quâ€™as-tu pris / testÃ© aujourdâ€™hui ?</label>
        <div class="chips">
          <label class="chip"><input type="checkbox" name="plants" value="Camomille"> ğŸŒ¼ Camomille</label>
          <label class="chip"><input type="checkbox" name="plants" value="MÃ©lisse"> ğŸƒ MÃ©lisse</label>
          <label class="chip"><input type="checkbox" name="plants" value="Verveine"> ğŸŒ¿ Verveine</label>
          <label class="chip"><input type="checkbox" name="plants" value="Djeka"> ğŸ«– Djeka</label>
          <label class="chip"><input type="checkbox" name="plants" value="KhamarÃ©"> ğŸ«– KhamarÃ©</label>
          <label class="chip"><input type="checkbox" name="plants" value="Bouillotte / chaleur"> ğŸ”¥ Bouillotte / chaleur</label>
          <label class="chip"><input type="checkbox" name="plants" value="MÃ©dicament"> ğŸ’Š MÃ©dicament</label>
          <label class="chip"><input type="checkbox" name="plants" value="Rien"> ğŸ™ƒ Rien</label>
        </div>

        <label style="margin-top:10px;">
          Est-ce que Ã§a tâ€™a aidÃ©e ?
          <span style="color:#6b7280;font-size:12px;">(parfois il faut plusieurs cycles)</span>
        </label>
        <div class="chips">
          <label class="chip"><input type="radio" name="plantsWorked" value="Oui"> Oui âœ…</label>
          <label class="chip"><input type="radio" name="plantsWorked" value="Un peu"> Un peu ğŸ™‚</label>
          <label class="chip"><input type="radio" name="plantsWorked" value="Pas vraiment"> Pas vraiment ğŸ˜•</label>
          <label class="chip"><input type="radio" name="plantsWorked" value="Je ne sais pas"> Je ne sais pas</label>
        </div>
      </div>

      <!-- ALIMENTATION -->
      <div id="foodBlock" style="display:none;">
        <label>Alimentation (simple, sans jugement)</label>
        <div class="chips">
          <label class="chip"><input type="checkbox" name="food" value="Jâ€™ai bu de lâ€™eau"> ğŸ’§ Jâ€™ai bu de lâ€™eau</label>
          <label class="chip"><input type="checkbox" name="food" value="Jâ€™ai mangÃ© maison"> ğŸ² PlutÃ´t maison</label>
          <label class="chip"><input type="checkbox" name="food" value="Fast-food / ultra transformÃ©"> ğŸŸ Fast-food / ultra transformÃ©

            const LS_KEY = "cycle_months_v4_full";

  function loadMonths(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
    catch { return []; }
  }
  function saveMonths(months){ localStorage.setItem(LS_KEY, JSON.stringify(months)); }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }
  function daysBetween(a,b){
    if(!a || !b) return 0;
    const diff = (new Date(b) - new Date(a)) / (1000*60*60*24);
    return Number.isFinite(diff) ? Math.max(0, Math.round(diff)+1) : 0;
  }
  function getCheckedValues(name){
    return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(x=>x.value);
  }
  function getRadioValue(name){
    return document.querySelector(`input[name="${name}"]:checked`)?.value ?? null;
  }

  const monthInput = document.getElementById("month");
  const nicknameInput = document.getElementById("nickname");
  const startDateInput = document.getElementById("startDate");
  const endDateInput = document.getElementById("endDate");

  const ramadanInput = document.getElementById("ramadan");
  const ramadanTotalInput = document.getElementById("ramadanTotal");
  const ramadanDoneInput = document.getElementById("ramadanDone");
  const ramadanRemainingInput = document.getElementById("ramadanRemaining");
  const ramadanPlusOneBtn = document.getElementById("ramadanPlusOneBtn");
  const ramadanDoneBtn = document.getElementById("ramadanDoneBtn");
  const ramadanResetBtn = document.getElementById("ramadanResetBtn");
  const ramadanCongrats = document.getElementById("ramadanCongrats");

  const statusBox = document.getElementById("monthStatusBox");
  const saveMonthBtn = document.getElementById("saveMonthBtn");
  const exportMonthBtn = document.getElementById("exportMonthBtn");

  const entryDate = document.getElementById("entryDate");
  const entryType = document.getElementById("entryType");
  const entryNotes = document.getElementById("entryNotes");

  const ovulationBlock = document.getElementById("ovulationBlock");
  const painBlock = document.getElementById("painBlock");
  const painDetails = document.getElementById("painDetails");
  const spmBlock = document.getElementById("spmBlock");
  const plantsBlock = document.getElementById("plantsBlock");
  const foodBlock = document.getElementById("foodBlock");

  const ovuSide = document.getElementById("ovuSide");
  const mucusType = document.getElementById("mucusType");

  const adviceBox = document.getElementById("adviceBox");
  const addEntryBtn = document.getElementById("addEntryBtn");
  const clearEntryBtn = document.getElementById("clearEntryBtn");

  const monthPainDetails = document.getElementById("monthPainDetails");
  const monthPainAdvice = document.getElementById("monthPainAdvice");

  // --- DonnÃ©es mois ---
  function getMonthObj(month){
    const months = loadMonths();
    return months.find(m=>m.month===month) || null;
  }
  function upsertMonth(month, patch){
    const months = loadMonths();
    const idx = months.findIndex(m=>m.month===month);
    const nowIso = new Date().toISOString();
    if(idx>=0){
      months[idx] = { ...months[idx], ...patch, updatedAt: nowIso };
    } else {
      months.push({ month, entries: [], createdAt: nowIso, updatedAt: nowIso, ...patch });
    }
    saveMonths(months);
  }

  function addEntryToMonth(month, entry){
    const months = loadMonths();
    const idx = months.findIndex(m=>m.month===month);
    if(idx<0){
      upsertMonth(month, readMonthFields());
      return addEntryToMonth(month, entry);
    }
    months[idx].entries = months[idx].entries || [];
    months[idx].entries.push(entry);
    months[idx].updatedAt = new Date().toISOString();
    saveMonths(months);
  }

  // --- Defaults ---
  const now = new Date();
  monthInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
  entryDate.valueAsDate = new Date();

  // --- Build scales 0-10 ---
  function buildScale(containerId, inputName){
    const c = document.getElementById(containerId);
    c.innerHTML = "";
    for(let i=0;i<=10;i++){
      const input = document.createElement("input");
      input.type = "radio";
      input.name = inputName;
      input.value = String(i);
      input.title = String(i);
      c.appendChild(input);
    }
  }
  buildScale("painScale", "painLevel");
  buildScale("monthPainScale", "monthPainLevel");

  // --- Ramadan rÃ©actif ---
  function renderRamadanRemaining(){
    const on = !!ramadanInput.checked;
    if(!on){
      ramadanTotalInput.disabled = true;
      ramadanDoneInput.disabled  = true;
      ramadanRemainingInput.value = "â€”";
      ramadanCongrats.style.display = "none";
      return;
    }
    ramadanTotalInput.disabled = false;
    ramadanDoneInput.disabled  = false;

    const total = Math.max(0, Number(ramadanTotalInput.value || 0));
    const done  = Math.max(0, Number(ramadanDoneInput.value || 0));
    const remaining = Math.max(0, total - done);

    ramadanRemainingInput.value = `${remaining} jour(s)`;
    ramadanCongrats.style.display = (total > 0 && remaining === 0) ? "block" : "none";
  }

  function autoSaveMonthIfPossible(){
    const month = monthInput.value;
    if(!month) return;
    upsertMonth(month, readMonthFields());
    renderMonthStatus();
    if(typeof refreshUI === "function") refreshUI();
  }

  ramadanInput.addEventListener("change", ()=>{
    if(!ramadanInput.checked){
      ramadanTotalInput.value = "";
      ramadanDoneInput.value = "";
    }
    renderRamadanRemaining();
    autoSaveMonthIfPossible();
  });
  ramadanTotalInput.addEventListener("input", ()=>{ renderRamadanRemaining(); autoSaveMonthIfPossible(); });
  ramadanDoneInput.addEventListener("input", ()=>{ renderRamadanRemaining(); autoSaveMonthIfPossible(); });

  ramadanPlusOneBtn.addEventListener("click", ()=>{
    if(!ramadanInput.checked) ramadanInput.checked = true;

    const total = Math.max(0, Number(ramadanTotalInput.value || 0));
    let done = Math.max(0, Number(ramadanDoneInput.value || 0));
    done += 1;
    if(total > 0) done = Math.min(done, total);

    ramadanDoneInput.value = String(done);
    renderRamadanRemaining();
    autoSaveMonthIfPossible();
  });

  ramadanDoneBtn.addEventListener("click", ()=>{
    if(!ramadanInput.checked) ramadanInput.checked = true;

    const total = Math.max(0, Number(ramadanTotalInput.value || 0));
    if(total <= 0){
      alert("Mets dâ€™abord ton total de jours Ã  rattraper ğŸ˜Š");
      return;
    }
    ramadanDoneInput.value = String(total);
    renderRamadanRemaining();
    autoSaveMonthIfPossible();
  });

  ramadanResetBtn.addEventListener("click", ()=>{
    ramadanInput.checked = false;
    ramadanTotalInput.value = "";
    ramadanDoneInput.value = "";
    renderRamadanRemaining();
    autoSaveMonthIfPossible();
  });

  // --- Conseil douleur (mois) ---
  function updateMonthPainAdvice(){
    const yesNo = getRadioValue("monthPainYesNo");
    if(yesNo !== "oui"){
      monthPainAdvice.style.display = "none";
      return;
    }
    const lvl = Number(getRadioValue("monthPainLevel") ?? 0);

    let msg = `ğŸ’¡ <b>Plan anti-douleur</b> : bouillotte + respiration + eau. `;
    if(lvl>=8){
      msg += `<br><br><b>8â€“10</b> : Djeka/KhamarÃ© dÃ¨s la douleur + repos. Si tu ne peux pas fonctionner â†’ parle Ã  un adulte + consulte.`;
    } else if(lvl>=5){
      msg += `<br><br><b>5â€“7</b> : bouillotte + tisane (camomille) ou Djeka/KhamarÃ© + rÃ©duire un peu sucre/ultra-transformÃ© 2â€“3 jours.`;
    } else if(lvl>=1){
      msg += `<br><br><b>1â€“4</b> : chaleur + tisane douce + note ce qui aide.`;
    } else {
      msg += `<br><br>Choisis un chiffre (0â€“10) pour noter.`;
    }
    msg += `<br><br><span style="color:#6b7280;font-size:12px;">(parfois il faut plusieurs cycles pour voir un vrai changement)</span>`;

    monthPainAdvice.innerHTML = msg;
    monthPainAdvice.style.display = "block";
  }

  document.addEventListener("change", (e)=>{
    if(e.target?.name === "monthPainYesNo"){
      const yes = e.target.value === "oui";
      monthPainDetails.style.display = yes ? "block" : "none";
      if(!yes){
        document.querySelectorAll('input[name="monthPainLevel"]').forEach(r=>r.checked=false);
        document.querySelectorAll('input[name="monthRelief"]').forEach(cb=>cb.checked=false);
        document.querySelectorAll('input[name="monthReliefWorked"]').forEach(r=>r.checked=false);
        monthPainAdvice.style.display = "none";
      } else {
        updateMonthPainAdvice();
      }
      autoSaveMonthIfPossible();
    }

    if(e.target?.name === "monthPainLevel" || e.target?.name === "monthRelief" || e.target?.name === "monthReliefWorked"){
      updateMonthPainAdvice();
      autoSaveMonthIfPossible();
    }

    if(e.target?.name === "painYesNo"){
      const yes = e.target.value === "oui";
      painDetails.style.display = yes ? "block" : "none";
      if(!yes){
        document.querySelectorAll('input[name="painWhere"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('input[name="painLevel"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="relief"]').forEach(cb => cb.checked = false);
        document.querySelectorAll('input[name="reliefWorked"]').forEach(r => r.checked = false);
      }
      updateAdvice();
    }

    if(e.target?.name === "painLevel"){
      updateAdvice();
    }
  });

  function readMonthFields(){
    const onRam = !!ramadanInput.checked;

    const monthPainYesNo = getRadioValue("monthPainYesNo");
    const monthPainLevel = Number(getRadioValue("monthPainLevel") ?? 0);

    return {
      nickname: nicknameInput.value.trim() || null,
      startDate: startDateInput.value || null,
      endDate: endDateInput.value || null,

      ramadan: onRam,
      ramadanTotal: onRam ? Math.max(0, Number(ramadanTotalInput.value || 0)) : 0,
      ramadanDone: onRam ? Math.max(0, Number(ramadanDoneInput.value || 0)) : 0,

      monthPain: monthPainYesNo,
      monthPainLevel: (monthPainYesNo==="oui") ? monthPainLevel : 0,
      monthRelief: (monthPainYesNo==="oui") ? getCheckedValues("monthRelief") : [],
      monthReliefWorked: (monthPainYesNo==="oui") ? getRadioValue("monthReliefWorked") : null
    };
  }

  function renderMonthStatus(){
    const m = getMonthObj(monthInput.value);
    if(!m){
      statusBox.innerHTML = `ğŸŸ¡ <b>${monthInput.value}</b> : pas encore enregistrÃ©.`;
      return;
    }
    const duration = daysBetween(m.startDate, m.endDate);
    const ramTxt = m.ramadan
      ? `ğŸŒ™ Ramadan : total <b>${m.ramadanTotal}</b> Â· rattrapÃ©s <b>${m.ramadanDone}</b> Â· reste <b>${Math.max(0,m.ramadanTotal-m.ramadanDone)}</b>`
      : `ğŸŒ™ Ramadan : non`;

    const painTxt = (m.monthPain==="oui")
      ? `ğŸ©¸ Douleur rÃ¨gles (mois) : <b>${m.monthPainLevel}/10</b> Â· AidÃ© ? <b>${m.monthReliefWorked || "â€”"}</b>`
      : `ğŸ©¸ Douleur rÃ¨gles (mois) : ${m.monthPain==="non" ? "<b>non</b>" : "â€”"}`;

    statusBox.innerHTML = `
      <div class="meta">
        <span class="pill">ğŸ“… ${m.month}</span>
        <span class="pill">ğŸ©¸ ${duration || 0} jours</span>
        <span class="pill">ğŸ—‚ï¸ ${(m.entries || []).length} entrÃ©es</span>
      </div>
      <div class="small">${painTxt}</div>
      <div class="small">${ramTxt}</div>
    `;
  }
      function syncMonthFieldsFromStorage(){
    const m = getMonthObj(monthInput.value);

    if(!m){
      nicknameInput.value = "";
      startDateInput.value = "";
      endDateInput.value = "";

      document.querySelectorAll('input[name="monthPainYesNo"]').forEach(r=>r.checked=false);
      monthPainDetails.style.display="none";
      document.querySelectorAll('input[name="monthPainLevel"]').forEach(r=>r.checked=false);
      document.querySelectorAll('input[name="monthRelief"]').forEach(cb=>cb.checked=false);
      document.querySelectorAll('input[name="monthReliefWorked"]').forEach(r=>r.checked=false);
      monthPainAdvice.style.display="none";

      ramadanInput.checked = false;
      ramadanTotalInput.value = "";
      ramadanDoneInput.value = "";
      renderRamadanRemaining();

      renderMonthStatus();
      if(typeof refreshUI === "function") refreshUI();
      return;
    }

    nicknameInput.value = m.nickname || "";
    startDateInput.value = m.startDate || "";
    endDateInput.value = m.endDate || "";

    // Month pain
    document.querySelectorAll('input[name="monthPainYesNo"]').forEach(r=>r.checked = (r.value===m.monthPain));
    if(m.monthPain==="oui"){
      monthPainDetails.style.display="block";
      document.querySelectorAll('input[name="monthPainLevel"]').forEach(r=>r.checked = (Number(r.value)===Number(m.monthPainLevel||0)));
      document.querySelectorAll('input[name="monthRelief"]').forEach(cb=>cb.checked = (m.monthRelief||[]).includes(cb.value));
      document.querySelectorAll('input[name="monthReliefWorked"]').forEach(r=>r.checked = (r.value===m.monthReliefWorked));
      updateMonthPainAdvice();
    } else {
      monthPainDetails.style.display="none";
      monthPainAdvice.style.display="none";
      document.querySelectorAll('input[name="monthPainLevel"]').forEach(r=>r.checked=false);
      document.querySelectorAll('input[name="monthRelief"]').forEach(cb=>cb.checked=false);
      document.querySelectorAll('input[name="monthReliefWorked"]').forEach(r=>r.checked=false);
    }

    // Ramadan
    ramadanInput.checked = !!m.ramadan;
    ramadanTotalInput.value = m.ramadan ? String(m.ramadanTotal ?? 0) : "";
    ramadanDoneInput.value  = m.ramadan ? String(m.ramadanDone ?? 0) : "";
    renderRamadanRemaining();

    renderMonthStatus();
    if(typeof refreshUI === "function") refreshUI();
  }

  monthInput.addEventListener("change", syncMonthFieldsFromStorage);

  saveMonthBtn.addEventListener("click", ()=>{
    const month = monthInput.value;
    if(!month){ alert("Choisis le mois."); return; }
    upsertMonth(month, readMonthFields());
    alert("Mois enregistrÃ© âœ…");
    renderMonthStatus();
    if(typeof refreshUI === "function") refreshUI();
  });

  exportMonthBtn.addEventListener("click", ()=>{
    const m = getMonthObj(monthInput.value);
    if(!m){ alert("Enregistre dâ€™abord le mois."); return; }

    const duration = daysBetween(m.startDate, m.endDate);
    const regs = (m.entries||[]).filter(e=>e.type==="regles" && e.pain==="oui" && typeof e.painLevel==="number");
    const avgPain = regs.length ? Math.round((regs.reduce((s,e)=>s+e.painLevel,0)/regs.length)*10)/10 : 0;

    const lines = [];
    lines.push(`Mois: ${m.month}`);
    if(m.nickname) lines.push(`Pseudo: ${m.nickname}`);
    lines.push(`RÃ¨gles: ${m.startDate || "â€”"} â†’ ${m.endDate || "â€”"} (durÃ©e: ${duration} jours)`);
    lines.push(`Douleur moyenne (jours notÃ©s): ${avgPain}/10`);
    lines.push(`Douleur rÃ¨gles (mois): ${m.monthPain==="oui" ? `${m.monthPainLevel}/10` : (m.monthPain==="non" ? "non" : "â€”")}`);
    if(m.monthPain==="oui"){
      lines.push(`Ce qui a aidÃ©: ${(m.monthRelief||[]).join(", ") || "â€”"}`);
      lines.push(`EfficacitÃ©: ${m.monthReliefWorked || "â€”"}`);
    }
    lines.push(`Ramadan: ${m.ramadan ? "oui" : "non"}`);
    if(m.ramadan){
      lines.push(`  Total: ${m.ramadanTotal}`);
      lines.push(`  DÃ©jÃ  rattrapÃ©s: ${m.ramadanDone}`);
      lines.push(`  Restants: ${Math.max(0, m.ramadanTotal - m.ramadanDone)}`);
    }

    lines.push("");
    lines.push("EntrÃ©es:");
    (m.entries||[]).slice().sort((a,b)=>(a.date||"").localeCompare(b.date||"")).forEach(e=>{
      lines.push(`- ${e.date} [${e.type}] ${e.notes ? e.notes : ""}`);
    });

    const blob = new Blob([lines.join("\n")], {type:"text/plain"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `suivi-cycle-${m.month}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // Entry type toggle
  entryType.addEventListener("change", ()=>{
    const t = entryType.value;
    ovulationBlock.style.display = (t === "ovulation") ? "block" : "none";
    painBlock.style.display      = (t === "regles") ? "block" : "none";
    spmBlock.style.display       = (t === "spm") ? "block" : "none";
    plantsBlock.style.display    = (t === "plantes") ? "block" : "none";
    foodBlock.style.display      = (t === "alimentation") ? "block" : "none";
    updateAdvice();
  });

  function updateAdvice(){
    const t = entryType.value;
    if(!t){ adviceBox.style.display="none"; return; }

    let msg = "";
    if(t === "regles"){
      const yesNo = getRadioValue("painYesNo");
      if(yesNo === "non"){
        msg = `ğŸ’¡ <b>Top</b> : pas de douleur aujourdâ€™hui âœ…`;
      } else if(yesNo === "oui"){
        const lvl = Number(getRadioValue("painLevel") ?? 0);
        msg = `ğŸ’¡ <b>Plan anti-douleur</b> : bouillotte + respiration + eau. `;
        if(lvl >= 8){
          msg += `<br><br><b>8â€“10</b> : Djeka/KhamarÃ© dÃ¨s la douleur + repos. Si tu ne peux pas fonctionner â†’ parle Ã  un adulte + consulte.`;
        } else if(lvl >= 5){
          msg += `<br><br><b>5â€“7</b> : bouillotte + tisane (camomille) ou Djeka/KhamarÃ© + rÃ©duire un peu sucre/ultra-transformÃ© 2â€“3 jours.`;
        } else if(lvl >= 1){
          msg += `<br><br><b>1â€“4</b> : chaleur + tisane douce + note ce qui aide.`;
        } else {
          msg += `<br><br>Choisis un chiffre (0â€“10) pour noter.`;
        }
        msg += `<br><br><span style="color:#6b7280;font-size:12px;">(parfois il faut plusieurs cycles pour voir un vrai changement)</span>`;
      } else {
        msg = `ğŸ’¡ Choisis dâ€™abord <b>oui</b> ou <b>non</b> pour la douleur.`;
      }
    }

    if(t === "ovulation"){
      msg = `ğŸ’¡ <b>Ovulation</b> : noter tes signes tâ€™aide Ã  te connaÃ®tre. Si douleurs souvent : Djeka/KhamarÃ© <b>3 jours autour de lâ€™ovulation</b> (3 cycles).`;
    }

    if(t === "spm"){
      msg = `ğŸ’¡ <b>SPM</b> : semaine avant â†’ camomille/mÃ©lisse/verveine le soir aide souvent (stress + sommeil).`;
    }

    if(t === "plantes"){
      msg = `ğŸ’¡ <b>Plantes</b> : Djeka/KhamarÃ© = dÃ©coction <b>10 min</b> (rincer avant) + rÃ©utilisable <b>2 fois</b>. Plantes douces = infusion 5â€“10 min.`;
    }

    if(t === "alimentation"){
      msg = `ğŸ’¡ <b>Alimentation</b> : si tu as mal, rÃ©duis juste un peu sucre + ultra-transformÃ© 2â€“3 jours. Ajoute eau + repas simple.`;
    }

    if(t === "note"){
      msg = `ğŸ’¡ Note ce que tu veux : sommeil, stress, douleur, ovulationâ€¦`;
    }

    adviceBox.innerHTML = msg;
    adviceBox.style.display = "block";
  }

  // Add entry
  addEntryBtn.addEventListener("click", ()=>{
    const month = monthInput.value;
    if(!month){ alert("Choisis le mois."); return; }
    if(!entryType.value){ alert("Choisis le type dâ€™entrÃ©e."); return; }
    if(!entryDate.value){ alert("Choisis une date."); return; }

    upsertMonth(month, readMonthFields());

    const entry = {
      id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())),
      date: entryDate.value,
      type: entryType.value,
      notes: entryNotes.value.trim() || null,
      createdAt: new Date().toISOString()
    };

    if(entry.type === "ovulation"){
      entry.signs = getCheckedValues("ovuSigns");
      entry.ovarySide = ovuSide.value || null;
      entry.mucusType = mucusType.value || null;
    }

    if(entry.type === "regles"){
      const yesNo = getRadioValue("painYesNo");
      entry.pain = yesNo;
      if(yesNo === "oui"){
        entry.painWhere = getCheckedValues("painWhere");
        entry.painLevel = Number(getRadioValue("painLevel") ?? 0);
        entry.relief = getCheckedValues("relief");
        entry.reliefWorked = getRadioValue("reliefWorked");
      } else {
        entry.painWhere = [];
        entry.painLevel = 0;
        entry.relief = [];
        entry.reliefWorked = null;
      }
    }

    if(entry.type === "spm") entry.mood = getCheckedValues("mood");

    if(entry.type === "plantes"){
      entry.plants = getCheckedValues("plants");
      entry.plantsWorked = getRadioValue("plantsWorked");
    }

    if(entry.type === "alimentation") entry.food = getCheckedValues("food");

    addEntryToMonth(month, entry);
    alert("EntrÃ©e enregistrÃ©e âœ¨");
    clearEntryFields();
    renderMonthStatus();
    if(typeof refreshUI === "function") refreshUI();
  });

  function clearEntryFields(){
    entryType.value = "";
    entryNotes.value = "";
    entryDate.valueAsDate = new Date();

    ovulationBlock.style.display = "none";
    painBlock.style.display      = "none";
    spmBlock.style.display       = "none";
    plantsBlock.style.display    = "none";
    foodBlock.style.display      = "none";
    painDetails.style.display    = "none";
    adviceBox.style.display      = "none";

    document.querySelectorAll('input[name="ovuSigns"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="painYesNo"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="painWhere"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="painLevel"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="relief"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="reliefWorked"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="mood"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="plants"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="plantsWorked"]').forEach(i=>i.checked=false);
    document.querySelectorAll('input[name="food"]').forEach(i=>i.checked=false);

    ovuSide.value = "";
    mucusType.value = "";
  }
  clearEntryBtn.addEventListener("click", clearEntryFields);

  // Init base
  renderRamadanRemaining();
  renderMonthStatus();
  syncMonthFieldsFromStorage();

   // ----- Tabs -----
  const tabs = Array.from(document.querySelectorAll(".tab"));
  const tabOverview = document.getElementById("tab-overview");
  const tabCurrent  = document.getElementById("tab-current");
  const tabHistory  = document.getElementById("tab-history");

  function setTab(name){
    tabs.forEach(t=>{
      const active = t.dataset.tab === name;
      t.classList.toggle("active", active);
    });
    tabOverview.style.display = (name==="overview") ? "block" : "none";
    tabCurrent.style.display  = (name==="current") ? "block" : "none";
    tabHistory.style.display  = (name==="history") ? "block" : "none";
  }
  tabs.forEach(t=> t.addEventListener("click", ()=> setTab(t.dataset.tab)));

  // ----- Current month display -----
  const currentMonthBox = document.getElementById("currentMonthBox");
  const currentEntriesList = document.getElementById("currentEntriesList");

  function renderCurrentMonth(){
    const m = getMonthObj(monthInput.value);
    if(!m){
      currentMonthBox.innerHTML = "Enregistre dâ€™abord ton mois pour voir le rÃ©cap ici ğŸ™‚";
      currentEntriesList.innerHTML = "";
      return;
    }

    const duration = daysBetween(m.startDate, m.endDate);
    const painMonth = (m.monthPain==="oui") ? `${m.monthPainLevel}/10` : (m.monthPain==="non" ? "non" : "â€”");

    currentMonthBox.innerHTML = `
      <div class="meta">
        <span class="pill">ğŸ“… ${m.month}</span>
        <span class="pill">ğŸ©¸ ${duration || 0} jours</span>
        <span class="pill">ğŸ—‚ï¸ ${(m.entries||[]).length} entrÃ©es</span>
      </div>
      <div class="small"><b>Douleur rÃ¨gles (mois)</b> : ${painMonth}</div>
      ${m.monthPain==="oui" ? `<div class="small">âœ… AidÃ© par : ${(m.monthRelief||[]).join(", ") || "â€”"} Â· EfficacitÃ© : <b>${m.monthReliefWorked||"â€”"}</b></div>` : ""}
      <div class="small">${m.ramadan ? `ğŸŒ™ Restants Ramadan : <b>${Math.max(0, (m.ramadanTotal||0) - (m.ramadanDone||0))}</b>` : `ğŸŒ™ Ramadan : non`}</div>
    `;

    const entries = (m.entries||[]).slice().sort((a,b)=>(a.date||"").localeCompare(b.date||""));

    currentEntriesList.innerHTML = entries.map(e=>{
      const extra = [];
      if(e.type==="regles" && e.pain==="oui"){
        extra.push(`Douleur: <b>${e.painLevel}/10</b>`);
        if(e.painWhere?.length) extra.push(`OÃ¹: ${e.painWhere.join(", ")}`);
        if(e.relief?.length) extra.push(`TestÃ©: ${e.relief.join(", ")}`);
        if(e.reliefWorked) extra.push(`AidÃ© ? <b>${escapeHtml(e.reliefWorked)}</b>`);
      }
      if(e.type==="ovulation"){
        if(e.signs?.length) extra.push(`Signes: ${e.signs.join(", ")}`);
        if(e.ovarySide) extra.push(`CÃ´tÃ©: ${escapeHtml(e.ovarySide)}`);
        if(e.mucusType) extra.push(`Pertes: ${escapeHtml(e.mucusType)}`);
      }
      if(e.type==="spm" && e.mood?.length) extra.push(`Humeur: ${e.mood.join(", ")}`);
      if(e.type==="plantes"){
        if(e.plants?.length) extra.push(`Pris: ${e.plants.join(", ")}`);
        if(e.plantsWorked) extra.push(`AidÃ© ? <b>${escapeHtml(e.plantsWorked)}</b>`);
      }
      if(e.type==="alimentation" && e.food?.length) extra.push(`Alim: ${e.food.join(", ")}`);

      const typeLabel = ({
        ovulation:"Ovulation",
        regles:"RÃ¨gles (jour)",
        spm:"SPM / humeur",
        plantes:"Plantes / solutions",
        alimentation:"Alimentation",
        note:"Note"
      }[e.type] || e.type);

      return `
        <div class="entry">
          <div class="meta">
            <span class="pill">${escapeHtml(e.date||"")}</span>
            <span class="pill">${escapeHtml(typeLabel)}</span>
            <button class="btn-ghost" type="button" data-del="${escapeHtml(e.id)}" style="padding:6px 10px;border-radius:10px;">Supprimer</button>
          </div>
          ${extra.length ? `<div class="small">${extra.join(" Â· ")}</div>` : ``}
          ${e.notes ? `<div class="small" style="margin-top:6px;">ğŸ“ ${escapeHtml(e.notes)}</div>` : ``}
        </div>
      `;
    }).join("");

    // delete entry handlers
    currentEntriesList.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(!confirm("Supprimer cette entrÃ©e ?")) return;
        deleteEntry(monthInput.value, btn.dataset.del);
        renderCurrentMonth();
        renderMonthStatus();
        refreshUI();
      });
    });
  }

  // ----- History -----
  const monthsList = document.getElementById("monthsList");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const exportBtn = document.getElementById("exportBtn");

  function renderHistory(){
    const months = loadMonths().slice().sort((a,b)=> (a.month||"").localeCompare(b.month||""));
    if(!months.length){
      monthsList.innerHTML = `<div class="note">Pas encore de donnÃ©es. Ton suivi apparaÃ®tra ici ğŸ™‚</div>`;
      return;
    }
    monthsList.innerHTML = months.map(m=>{
      const duration = daysBetween(m.startDate, m.endDate);
      const ramRemain = m.ramadan ? Math.max(0,(m.ramadanTotal||0)-(m.ramadanDone||0)) : null;
      const painTxt = (m.monthPain==="oui") ? `${m.monthPainLevel}/10` : (m.monthPain==="non" ? "non" : "â€”");
      return `
        <div class="entry">
          <div class="meta">
            <span class="pill">ğŸ“… ${escapeHtml(m.month)}</span>
            <span class="pill">ğŸ©¸ ${duration || 0} j</span>
            <span class="pill">ğŸ—‚ï¸ ${(m.entries||[]).length} entrÃ©es</span>
          </div>
          <div class="small"><b>Douleur (mois)</b> : ${painTxt}</div>
          ${m.monthPain==="oui" ? `<div class="small">AidÃ© ? <b>${escapeHtml(m.monthReliefWorked||"â€”")}</b></div>` : ``}
          ${ramRemain!==null ? `<div class="small">ğŸŒ™ Restants Ramadan : <b>${ramRemain}</b></div>` : `<div class="small">ğŸŒ™ Ramadan : non</div>`}
        </div>
      `;
    }).join("");
  }

  clearAllBtn.addEventListener("click", ()=>{
    if(!confirm("Tout supprimer sur CET appareil ?")) return;
    localStorage.removeItem(LS_KEY);
    alert("Tout a Ã©tÃ© supprimÃ© âœ…");
    syncMonthFieldsFromStorage();
    refreshUI();
  });

  exportBtn.addEventListener("click", ()=>{
    const months = loadMonths();
    const blob = new Blob([JSON.stringify(months, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "suivi-cycle-export.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  // ----- Charts -----
  const painChartCanvas = document.getElementById("painChart");
  const durationChartCanvas = document.getElementById("durationChart");
  let painChart = null;
  let durationChart = null;

  function computePainByMonth(months){
    // use month-level pain if set; otherwise average daily pains
    return months.map(m=>{
      let v = null;
      if(m.monthPain==="oui") v = Number(m.monthPainLevel||0);
      else if(m.monthPain==="non") v = 0;
      else {
        const regs = (m.entries||[]).filter(e=>e.type==="regles" && e.pain==="oui" && typeof e.painLevel==="number");
        if(regs.length){
          v = regs.reduce((s,e)=>s+Number(e.painLevel||0),0)/regs.length;
        } else {
          v = null;
        }
      }
      return {month:m.month, value:v};
    });
  }

  function computeDurationByMonth(months){
    return months.map(m=>{
      const d = daysBetween(m.startDate, m.endDate);
      return {month:m.month, value:d || 0};
    });
  }

  function renderCharts(){
    const months = loadMonths().slice().sort((a,b)=> (a.month||"").localeCompare(b.month||""));
    const pain = computePainByMonth(months);
    const duration = computeDurationByMonth(months);

    const labels = months.map(m=>m.month);

    const painData = pain.map(x=> (x.value===null ? null : Number(x.value)));
    const durationData = duration.map(x=> Number(x.value||0));

    if(painChart) painChart.destroy();
    if(durationChart) durationChart.destroy();

    painChart = new Chart(painChartCanvas, {
      type:"line",
      data:{
        labels,
        datasets:[{
          label:"Douleur (0â€“10)",
          data:painData,
          spanGaps:true,
          tension:.25
        }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{display:true} },
        scales:{
          y:{ min:0, max:10, ticks:{ stepSize:1 } }
        }
      }
    });

    durationChart = new Chart(durationChartCanvas, {
      type:"bar",
      data:{
        labels,
        datasets:[{
          label:"DurÃ©e des rÃ¨gles (jours)",
          data:durationData
        }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{display:true} },
        scales:{
          y:{ beginAtZero:true, ticks:{ stepSize:1 } }
        }
      }
    });
  }

  // ----- refreshUI global -----
  function refreshUI(){
    renderCurrentMonth();
    renderHistory();
    renderCharts();
  }
  window.refreshUI = refreshUI;

  // Initial render + keep synced when month changes
  monthInput.addEventListener("change", ()=>{
    renderCurrentMonth();
    renderCharts();
  });

  // First paint
  refreshUI();
  setTab("overview");
</script>
</body>
    </html>   
